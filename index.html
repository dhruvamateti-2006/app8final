<!DOCTYPE html>
<html lang="en">

<!-- The following code has been developed by students and/or researchers of the Freshman Research Initiative, DIY Diagnostics Stream at The University of Texas at Austin.  This code is shared for demonstration purposes and should not be considered a product -- it is for entertainment purposes only.  Any user of this code does so at their own risk. Members of the DIY Stream, FRI, and The University of Texas system are not liable for anything related to this code.
 
  THIS CODE SHOULD NOT BE USED TO DIAGNOSE ANY KIND OF MEDICAL CONDITION.
 
  Further Information:
  http://cns.utexas.edu/fri
 
  Research Educator:
  Timothy E. Riedel
  triedel@utexas.edu
 
  Authors in chronological order of contribution:
  Author 1: Timothy E. Riedel
  Author 2: Vishruth Batchu
  
  References:
  http://docs.webplatform.org/wiki/concepts/programming/drawing_images_onto_canvas#Loading_the_image_programmatically
  http://www.html5rocks.com/en/tutorials/file/dndfiles/
  http://www.w3.org/TR/FileAPI/
  http://mobilehtml5.org/
  http://stackoverflow.com/questions/11929099/html5-canvas-drawimage-ratio-bug-ios
  
  Brief Description of Goal of Code:
  Upload an image and process it
 
  Known Issues:
  None
-->

<head>
  <meta charset="utf-8">
  <title>Photo Transform</title>   //sets the title of the page which is shown in the browser tab//
  <meta name="viewport" content="width=device-width, initial-scale=.7">     //controls how the pages scale on mobile devices//
  <meta name="apple-mobile-web-app-capable" content="yes">                  //allows the webpage to run as a standalone app on IOS//
  <link rel="stylesheet" href="https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />  //imports jQuery Mobile CSS for styling//
  <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="https://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>

  <script>
    function detectVerticalSquash(img) {                      //fixes the bug on IOS where images might appear squashed//
      var iw = img.naturalWidth, ih = img.naturalHeight;
      var canvas = document.createElement('canvas');
      canvas.width = 1;
      canvas.height = ih;
      var ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      var data = ctx.getImageData(0, 0, 1, ih).data;
      var sy = 0;
      var ey = ih;
      var py = ih;
      while (py > sy) {
        var alpha = data[(py - 1) * 4 + 3];
        if (alpha === 0) {
          ey = py;
        } else {
          sy = py;
        }
        py = (ey + sy) >> 1;
      }
      var ratio = (py / ih);
      return (ratio === 0) ? 1 : ratio;
    }

    function drawImageIOSFix(ctx, img, sx, sy, sw, sh, dx, dy, dw, dh) {              //Uses the above function to draw images on the canvas, correcting for IOS squashing issues//
      var vertSquashRatio = detectVerticalSquash(img);
      ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh / vertSquashRatio);
    }
//window.onload necessary to keep javascripts from running before the app gets a chance to load entirely//
    window.onload = function () {
      var context, context2;
//sets text for canvas 1//     
     var canvas = document.getElementById('myCanvas');              //Gets the first canvas from HTML//
      context = canvas.getContext("2d"); 
      context.font = '20pt Calibri'; //sets font for canvas 1
      context.fillStyle = "black"; //sets font color for canvas 1//
      context.fillText("Original image will go here", 10, 20); //on canvas 1//
//sets text for canvas 2//
      var canvas2 = document.getElementById('myCanvas2');       //Gets the second canvas from HTML//
      context2 = canvas2.getContext("2d");
      context2.font = '20pt Calibri'; //sents font for canvas 2
      context2.fillStyle = "black"; //sets font color for canvas 2//
      context2.fillText("Transformed image will go here", 10, 20);   //on canvas 2//

/* fileInput.addEventListener looks for any change in the <input> tag indicating that the user has selected a file (picture). */
      var fileInput = document.getElementById('fileInput');
      var messageDisplayArea = document.getElementById('messageDisplayArea');

      var docMod = document.lastModified;
      alert("This file last modified " + docMod);             //this and the code below logs it in the console//
      console.log("This file last modified  " + docMod);

      fileInput.addEventListener('change', function () {
        var file = fileInput.files[0];                       //Gets the first selected file//
        var imageType = /image.*/;                           //Regex to match image file type//

        if (file && file.type.match(imageType)) {
          var reader = new FileReader();
          reader.onload = function (e) {
            messageDisplayArea.innerHTML = "Congrats for picking an image!";           //displays after you selecting image//
            var img = new Image();
            img.onload = function () {
              drawImageIOSFix(context, img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, 600, 500);
//this function draws the image onto the canvas and sets the dimensions of the image on IOS//
              var imageData = context.getImageData(0, 0, 600, 500);
              var pixels = imageData.data;

              for (var i = 0; i < pixels.length; i += 4) {
                pixels[i] = 0;     // Red
                pixels[i + 1] = 0; // Green
              }

              context2.putImageData(imageData, 0, 0);
            };
            img.src = reader.result;
          };
          reader.readAsDataURL(file);
        } else {
          messageDisplayArea.innerHTML = "File not supported!";
        }
      });
    };
  </script>
</head>

<body>
  <div data-role="page">
    <div data-role="header">
      <h1>Primary Colors</h1>
    </div>

    <div data-role="content">
      <h2>Change the color of your picture to become blue.</h2>   
      <div>
        Press button to create or choose image file:
        <input type="file" id="fileInput" style="background-color: #FF6600;">
      </div>
      <div id="messageDisplayArea"></div>

      <canvas id="myCanvas" width="600" height="500" style="border:1px solid #d3d3d3;"></canvas>    /
      <canvas id="myCanvas2" width="600" height="500" style="border:1px solid #d3d3d3;"></canvas>
    </div>

    <div data-role="footer" data-position="fixed">
    
//footer//     
     <p>DIY Diagnostics</p>
    </div>
  </div>
</body>
</html>
